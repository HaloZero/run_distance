<head>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpxzAN7i8ElCOC0w3SJWmZMjrXH5WD7Dg&sensor=true"></script>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</head>

<style>
  #map-canvas {
    height: 100%;
    width: 100%;
  }

  #input-box .input-group {
    margin: 10px 0;
    background: white;
    position: fixed;
    top: 20%;
    left: 50%;
    margin-top: -20px;
    margin-left: -100px;
    text-align: center;
    width: 200px;
    height: 50px;
    border: 1px solid #000;
  }
</style>
<body>
  <div id="map-canvas"></div>
  <div id="input-box">
    <form>
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Location">
      </div>
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Distance">
        <span class="input-group-addon">miles</span>
      </div>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
  </div>
</body>

<script type="text/javascript">


function initialize() {
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(positionCallback);
  } else {
    alert("Need current location");
  }
}

function positionCallback(position) {
  var coords = position.coords;
  var coordinate = new google.maps.LatLng(coords.latitude, coords.longitude);
  setupMap(coordinate);
}

function setupMap(center) {
  var mapOptions = {
    center: center,
    zoom: 17,
    mapTypeId: google.maps.MapTypeId.ROADMAP,

  };
  var map = new google.maps.Map(document.getElementById("map-canvas"),
      mapOptions);
  $("input").bind("keyup", function() {
    var $this = $(this);
    var delay = 1000; // 2 seconds delay after last input

    clearTimeout($this.data('timer'));
    $this.data('timer', setTimeout(function(){
        $this.removeData('timer');

        // Do your stuff after 2 seconds of last user input
        distanceRan($this.val(), center, map);
    }, delay));
  })
  distanceRan(50, center, map);
}


function distanceRan(distance, center, map) {
  console.log('distance ran', distance);
  var distanceRan = distance * 1000;
 //converts to meters
  var circleOptions = {
    radius: distanceRan,
    center: center,
    map: map,
    strokeColor: '#FF0000',
    strokeOpacity: 0.8,
    strokeWeight: 2
  };

  var circle = new google.maps.Circle(circleOptions);

  map.fitBounds(circle.getBounds());

  var bounds = circle.getBounds();
  var NE = bounds.getNorthEast();
  var SW = bounds.getSouthWest();
  var north = NE.lat();
  var east = NE.lng();
  var south = SW.lat();
  var west = SW.lng();

  var URL = "http://localhost:4567/locations?"
  +"n="+north
  +"&s="+south
  +"&e="+east
  +"&w="+west;

  var cityRequest = $.ajax({
    url: URL,
    contentType: "application/json",
    dataType: 'json',
    type: "GET",
    tryCount: 1,
    retryLimit: 5
  }).success(function(response) {
    if (response.success && false) {
      var cities = response.cities;
      console.log("found ", cities.length, " cities");
      $.each(cities, function(_, city) {
          var location = new google.maps.LatLng(city.lat, city.lng);
          var distance = google.maps.geometry.spherical.computeDistanceBetween(location, center);
          if (distance <= distanceRan) {
            var cityPin = new google.maps.Marker({
              map:map,
              draggable:false,
              animation: google.maps.Animation.DROP,
              position: location,
              title: city.name
            });
            google.maps.event.addListener(
              cityPin,
              'click',
              function(cityPin) {
                return function () { toggleName(cityPin) }
              }(cityPin)
            );
          }
      });
    } else {
      if (this.tryCount <= this.retryLimit) {
        console.log("trying again");
        this.tryCount++;
        $.ajax(cityRequest);
      } else {
        alert("Could not retrieve nearby locations. Try loading later");
      }
      console.log("response fail");
    }
  }).fail(function() {
    console.log(cityRequest);
  }).done(function() {
    console.log("done");
  });
}

function toggleName(marker) {
  alert(marker.title);
}

google.maps.event.addDomListener(window, 'load', initialize);


</script>